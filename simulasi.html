<!DOCTYPE html>
<html lang="id">
<head>
  <title>Simulasi | TRY OUT SMPN 10 BANAWA SELATAN</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #326698 0%, #4a7fb8 100%);
      font-family: 'Poppins', sans-serif;
      color: #333;
    }
    .option-label {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .option-label:hover {
      background-color: #e3f2fd;
    }
    .option-label.selected {
      background-color: #cfe2ff;
      border-color: #0d6efd !important;
    }
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 2000;
      display: none;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="container-fluid text-white shadow-lg"
     style="background: linear-gradient(135deg, #326698 0%, #4a7fb8 100%);
            height:110px; position:fixed; top:0; left:0; right:0; z-index:1000;">
  <div class="row h-100 align-items-center">
    <div class="col-12 text-center">
      <h4 class="font-weight-bold mb-1">SMPN 10 BANAWA SELATAN</h4>
      <p class="mb-0" id="mapel-header" style="font-size: 14px;">TRY OUT</p>
    </div>
  </div>
</div>

<!-- KONTEN -->
<div class="wrapper" style="margin: 0 auto; display:flex; justify-content:center; align-items:center; min-height:100vh; padding-top:140px;">
  <div id="formContent" style="max-width:800px; width:90%;">

    <div class="d-flex justify-content-between mb-3">
      <span id="user-info" style="font-weight:600; color:#fff;"></span>
      <span id="question-counter" style="font-weight:600; color:#fff;"></span>
    </div>

    <div id="quiz-container">
      <div id="question-text" class="mb-3 text-white" style="font-size:1.1rem; font-weight:500;"></div>
      <div id="options-container"></div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Sebelumnya</button>
      <button id="next-btn" class="btn btn-primary">Berikutnya<i class="fas fa-arrow-right ml-2"></i></button>
      <button id="submit-btn" class="btn btn-success" style="display:none;"><i class="fas fa-check-circle mr-2"></i>Selesai</button>
    </div>
  </div>
</div>

<!-- LOADER -->
<div id="loader">
  <img src="https://pusmendik.kemdikbud.go.id/tka/_assets/images/loader2.gif"
       style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);">
</div>

<script>
// ‚úÖ GANTI DENGAN URL WEB APP PUNYAMU (sudah terhubung dengan kode Apps Script final)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbya5PHRXvH6OXuKMBBUarGSvPpqfW5dUa_ueIML8wnkr-LRebjEOsA-11nvzBBB5FqmEQ/exec";

let userData, mapelData, allQuestions = [], currentQuestionIndex = 0, userAnswers = [];

$(document).ready(function() {
  userData = JSON.parse(sessionStorage.getItem('user_tryout'));
  mapelData = JSON.parse(sessionStorage.getItem('mapel_tryout'));

  if (!userData || !mapelData) {
    alert('Sesi Anda telah berakhir. Silakan login kembali.');
    window.location.href = 'index.html';
    return;
  }

  $('#user-info').text('üë§ ' + userData.nama);
  $('#mapel-header').text('Mata Pelajaran: ' + mapelData.nama);
  $('#loader').fadeIn();

  // üîπ Ambil soal dari Apps Script (GET -> getSoal)
  $.getJSON(SCRIPT_URL, { action: "getSoal", mapel: mapelData.id })
    .done(function(result) {
      if (result && result.length > 0) {
        allQuestions = result;
        userAnswers = new Array(result.length).fill(null);
        displayQuestion(0);
      } else {
        $('#quiz-container').html('<h4 class="text-danger">Tidak ada soal untuk mapel ini.</h4>');
      }
      $('#loader').fadeOut();
    })
    .fail(function() {
      alert("‚ö†Ô∏è Gagal memuat soal. Pastikan koneksi internet aktif.");
      $('#loader').fadeOut();
    });

  $('#next-btn').click(function() {
    saveAnswer();
    if (currentQuestionIndex < allQuestions.length - 1) {
      currentQuestionIndex++;
      displayQuestion(currentQuestionIndex);
    }
  });

  $('#prev-btn').click(function() {
    saveAnswer();
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion(currentQuestionIndex);
    }
  });

  $('#submit-btn').click(function() {
    saveAnswer();
    if (confirm('Apakah Anda yakin ingin menyelesaikan ujian ini?')) finishExam();
  });
});

function displayQuestion(index) {
  const q = allQuestions[index];
  $('#question-text').html((index + 1) + ". " + q.pertanyaan);

  let html = '';
  html += createOption('a', q.opsi_a);
  html += createOption('b', q.opsi_b);
  html += createOption('c', q.opsi_c);
  html += createOption('d', q.opsi_d);
  $('#options-container').html(html);

  if (userAnswers[index]) {
    $('#option-' + userAnswers[index]).prop('checked', true).parent().addClass('selected');
  }

  $('#prev-btn').prop('disabled', index === 0);
  $('#next-btn').toggle(index < allQuestions.length - 1);
  $('#submit-btn').toggle(index === allQuestions.length - 1);
  $('#question-counter').text('Soal ' + (index + 1) + ' / ' + allQuestions.length);

  $('.option-input').on('change', function() {
    $('.option-label').removeClass('selected');
    if ($(this).is(':checked')) $(this).parent().addClass('selected');
  });
}

function createOption(letter, text) {
  return `
    <label class="option-label d-block border rounded p-2 mb-2 bg-white text-dark">
      <input type="radio" class="option-input" name="option" id="option-${letter}" value="${letter}">
      <strong class="mr-2 text-primary">${letter.toUpperCase()}.</strong> ${text}
    </label>`;
}

function saveAnswer() {
  const selected = $('input[name="option"]:checked').val();
  if (selected) userAnswers[currentQuestionIndex] = selected;
}

function finishExam() {
  $('#loader').fadeIn();
  let benar = 0;
  allQuestions.forEach((q, i) => { if (userAnswers[i] === q.kunci) benar++; });

  const total = allQuestions.length;
  const salah = total - benar;
  const skor = Math.round((benar / total) * 100);

  const postData = {
    namaSiswa: userData.nama,
    mapel: mapelData.nama,
    skor,
    benar,
    salah,
    total,
    jawaban: userAnswers
  };

  // üîπ Kirim hasil ke Google Sheet via doPost
  $.ajax({
    type: "POST",
    url: SCRIPT_URL,
    data: JSON.stringify(postData),
    contentType: "text/plain;charset=utf-8",
    dataType: "json",
    success: function() {
      $('#loader').fadeOut();
      showResults(skor, total, benar, salah);
      sessionStorage.clear();
    },
    error: function() {
      $('#loader').fadeOut();
      alert("‚ö†Ô∏è Gagal menyimpan hasil ke server. Silakan lapor ke pengawas.");
      showResults(skor, total, benar, salah);
      sessionStorage.clear();
    }
  });
}

function showResults(skor, total, benar, salah) {
  $('#formContent').html(`
    <div class="text-center text-white">
      <h3 class="mb-3"><i class="fas fa-check-circle text-success"></i> Ujian Selesai</h3>
      <h4>Skor Akhir: <strong>${skor}</strong></h4>
      <p>Total Soal: ${total}</p>
      <p>Benar: ${benar} | Salah: ${salah}</p>
      <button class="btn btn-light mt-3" onclick="window.location.href='index.html'">
        <i class="fas fa-home mr-2"></i>Kembali ke Halaman Utama
      </button>
    </div>
  `);
}
</script>
</body>
</html>
