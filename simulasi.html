<!DOCTYPE html>
<html lang="en">
<head>
  <title>Simulasi | TRY OUT</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body style="background: linear-gradient(135deg, #326698 0%, #4a7fb8 100%, #667eea 100%); font-family: 'Poppins', sans-serif;">

<div class="container-fluid text-white" 
	style="background: linear-gradient(135deg, #326698 0%, #4a7fb8 100%); box-shadow: 0 4px 20px rgba(0,0,0,0.1); height:120px; position:fixed; top:0px; left:0px; right:0px; z-index:1000;"
	>
	  <div class="row h-100 align-items-center">
		<div class="col-12">
			<div class="d-flex align-items-center justify-content-center">
				<div class="header-text">
					<h3 class="mb-1" style="font-weight: 700; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">SMPN 10 BANAWA SELATAN</h3>
					<p class="mb-0" style="font-size: 14px; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.3);" id="mapel-header">TRY OUT</p>
				</div>
			</div>
		</div>
	  </div>
</div>

<div class="wrapper " style="margin: 0 auto; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding-top: 140px;">
  <div id="formContent" style="max-width: 800px; width: 90%;">
    
	<div class="d-flex justify-content-between mb-3" style="flex-wrap: wrap;">
		<span id="user-info" style="font-weight: 600; color: #333; margin-bottom: 5px;"></span>
		<span id="question-counter" style="font-weight: 600; color: #333; margin-bottom: 5px;"></span>
	</div>
	
	<div id="quiz-container">
		<div id="question-text" style="font-size: 1.1rem; font-weight: 500; color: #000; text-align: left; margin-bottom: 20px;">
			</div>
		
		<div id="options-container" style="text-align: left;">
			</div>
	</div>
	
	<div class="d-flex justify-content-between mt-4">
		<button id="prev-btn" class="btn btn-secondary" style="border-radius: 12px; padding: 12px 25px;"><i class="fas fa-arrow-left mr-2"></i>Sebelumnya</button>
		<button id="next-btn" class="btn btn-primary custom-btn" style="padding: 12px 25px;">Berikutnya<i class="fas fa-arrow-right ml-2"></i></button>
		<button id="submit-btn" class="btn btn-success" style="border-radius: 12px; padding: 12px 25px; display: none;"><i class="fas fa-check-circle mr-2"></i>Selesai</button>
	</div>

  </div> 
</div>

<div  style="position:absolute;top:0px;left:0px;right:0px;bottom:0px;background:#fff;opacity:0.5;z-index:99999;display:none" id="loader">
<img class="loader" src="https://pusmendik.kemdikbud.go.id/tka/_assets/images/loader2.gif" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
</div>

<style>
/* ... (Salin semua CSS dari index.html) ... */
	.bg-pattern {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-image: 
			radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 2px, transparent 2px),
			radial-gradient(circle at 80% 80%, rgba(255,255,255,0.08) 2px, transparent 2px),
			radial-gradient(circle at 40% 40%, rgba(255,255,255,0.05) 1px, transparent 1px);
		background-size: 50px 50px, 80px 80px, 30px 30px;
		z-index: -1;
	}
	.loader {
	  margin: 0;
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  -ms-transform: translate(-50%, -50%);
	  transform: translate(-50%, -50%);
	}
	.wrapper {
	  display: flex;
	  align-items: center;
	  flex-direction: column; 
	  justify-content: center;
	  width: 100%;
	  min-height: 100vh;
	  padding: 20px;
	  padding-bottom: 80px; /* beri ruang untuk footer */
	  margin: 0 auto;
	  text-align: center;
	}
	#formContent {
	  -webkit-border-radius: 20px;
	  border-radius: 20px;
	  background: #ffffff;
	  padding: 45px;
	  width: 90%;
	  max-width: 800px; /* Lebarkan untuk soal */
	  position: relative;
	  -webkit-box-shadow: 0 15px 35px 0 rgba(50, 102, 152, 0.1);
	  box-shadow: 0 15px 35px 0 rgba(50, 102, 152, 0.1);
	  text-align: center;
	  border: 1px solid rgba(255,255,255,0.8);
	}
	.header-text h3 {
		margin: 0;
		letter-spacing: 1px;
	}
	.header-text p {
		margin: 0;
		font-weight: 400;
	}
	.custom-btn {
		background: linear-gradient(135deg, #326698 0%, #4a7fb8 100%);
		border: none;
		border-radius: 12px;
		padding: 16px 30px;
		font-weight: 600;
		font-size: 16px;
		transition: all 0.3s ease;
		box-shadow: 0 6px 20px rgba(50, 102, 152, 0.25);
		position: relative;
		overflow: hidden;
	}
	.custom-btn::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
		transition: left 0.5s;
	}
	.custom-btn:hover::before {
		left: 100%;
	}
	.custom-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 8px 25px rgba(50, 102, 152, 0.35);
		background: linear-gradient(135deg, #4a7fb8 0%, #326698 100%);
	}
	.custom-btn:active {
		transform: translateY(0);
	}
	@media (max-width: 768px) {
		#formContent {
			margin: 20px;
			padding: 25px;
		}
		.container-fluid {
			height: 100px !important;
		}
		.header-text h3 {
			font-size: 20px !important;
		}
		.header-text p {
			font-size: 12px !important;
		}
		.custom-btn {
			padding: 14px 25px;
			font-size: 15px;
		}
	}
	#loader {
		background: rgba(50, 102, 152, 0.1);
	}
	
	/* CSS Khusus untuk Opsi Jawaban */
	.option-label {
		display: block;
		background: #f8f9fa;
		border: 2px solid #e8ecf1;
		border-radius: 12px;
		padding: 15px;
		margin-bottom: 10px;
		cursor: pointer;
		transition: all 0.2s ease;
		color: #333;
	}
	.option-label:hover {
		background: #e9ecef;
		border-color: #4a7fb8;
	}
	.option-label.selected {
		background: #d4edda;
		border-color: #28a745;
		font-weight: 600;
	}
	.option-input {
		display: none; /* Sembunyikan radio button asli */
	}
	.option-letter {
		display: inline-block;
		width: 25px;
		height: 25px;
		line-height: 21px;
		text-align: center;
		border: 2px solid #326698;
		border-radius: 50%;
		margin-right: 15px;
		font-weight: 600;
		color: #326698;
	}
	.option-label.selected .option-letter {
		background: #28a745;
		border-color: #28a745;
		color: white;
	}
</style>

<script>
	// ⬇️ GANTI DENGAN URL APPS SCRIPT BARU ANDA DARI LANGKAH 2 ⬇️
	var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhYDN_hX1YrtxDx6kk6yV3NqMf9wlLqFPubPugSVopBd1fWWIvN1znN77pMDJWwKgxzA/exec";

	var userData, mapelData;
	var allQuestions = [];
	var currentQuestionIndex = 0;
	var userAnswers = []; // Array untuk menyimpan jawaban (misal: ['A', 'C', null, 'B'])

	$(document).ready(function() {
		// 1. Verifikasi Login dan Mapel
		userData = JSON.parse(sessionStorage.getItem('user_tryout'));
		mapelData = JSON.parse(sessionStorage.getItem('mapel_tryout'));

		if (!userData || !mapelData) {
			alert('Sesi Anda telah berakhir. Silakan login kembali.');
			window.location.href = 'index.html';
			return;
		}

		// 2. Tampilkan Info
		$('#user-info').text('Siswa: ' + userData.nama);
		$('#mapel-header').text('Mapel: ' + mapelData.nama);
		$('#loader').fadeIn();

		// 3. Ambil Soal dari Apps Script
		$.ajax({
			type: "GET",
			dataType: "json",
			data: { 
				action: "getSoal",
				mapel: mapelData.id
			},
			url: SCRIPT_URL,
			cache: false,
			success: function(result) {
				if (result && result.length > 0) {
					allQuestions = result;
					// Siapkan array jawaban (null = belum dijawab)
					userAnswers = new Array(allQuestions.length).fill(null); 
					displayQuestion(currentQuestionIndex);
					$('#loader').fadeOut();
				} else {
					$('#quiz-container').html('<h3 class="text-danger">Gagal memuat soal.</h3><p>Tidak ada soal ditemukan untuk mata pelajaran ini.</p>');
					$('#loader').fadeOut();
				}
			},
			error: function() {
				$('#quiz-container').html('<h3 class="text-danger">Error Server.</h3><p>Gagal terhubung ke database soal. Silakan coba lagi nanti.</p>');
				$('#loader').fadeOut();
			}
		});

		// 4. Atur Tombol Navigasi
		$('#next-btn').on('click', function() {
			saveAnswer();
			if (currentQuestionIndex < allQuestions.length - 1) {
				currentQuestionIndex++;
				displayQuestion(currentQuestionIndex);
			}
		});

		$('#prev-btn').on('click', function() {
			saveAnswer();
			if (currentQuestionIndex > 0) {
				currentQuestionIndex--;
				displayQuestion(currentQuestionIndex);
			}
		});
		
		$('#submit-btn').on('click', function() {
			saveAnswer(); // Simpan jawaban terakhir
			if (confirm('Apakah Anda yakin ingin menyelesaikan ujian ini?')) {
				finishExam();
			}
		});
	});

	function displayQuestion(index) {
		var q = allQuestions[index];
		$('#question-text').html((index + 1) + ". " + q.pertanyaan);
		
		var optionsHtml = '';
		optionsHtml += createOption('A', q.opsi_a);
		optionsHtml += createOption('B', q.opsi_b);
		optionsHtml += createOption('C', q.opsi_c);
		optionsHtml += createOption('D', q.opsi_d);
		
		$('#options-container').html(optionsHtml);
		
		// Set jawaban sebelumnya jika ada
		if (userAnswers[index]) {
			$('#option-' + userAnswers[index]).prop('checked', true).parent().addClass('selected');
		}

		// Atur visibilitas tombol
		$('#prev-btn').prop('disabled', index === 0);
		$('#next-btn').toggle(index < allQuestions.length - 1);
		$('#submit-btn').toggle(index === allQuestions.length - 1);
		
		$('#question-counter').text('Soal ' + (index + 1) + ' / ' + allQuestions.length);
		
		// Atur event listener untuk pilihan
		$('.option-input').on('change', function() {
			$('.option-label').removeClass('selected');
			if ($(this).is(':checked')) {
				$(this).parent().addClass('selected');
			}
		});
	}
	
	function createOption(letter, text) {
		return `
			<label class="option-label">
				<input type="radio" class="option-input" name="option" id="option-${letter}" value="${letter}">
				<span class="option-letter">${letter}</span>
				${text}
			</label>
		`;
	}
	
	function saveAnswer() {
		var selectedOption = $('input[name="option"]:checked').val();
		if (selectedOption) {
			userAnswers[currentQuestionIndex] = selectedOption;
		}
	}
	
	function finishExam() {
		$('#loader').fadeIn();
		
		// 1. Hitung skor
		var score = 0;
		for (var i = 0; i < allQuestions.length; i++) {
			if (userAnswers[i] === allQuestions[i].kunci) {
				score++;
			}
		}
		
		var totalQuestions = allQuestions.length;
		var finalScore = (score / totalQuestions) * 100;
		var correctAnswers = score;
		var wrongAnswers = totalQuestions - score;
		
		// 2. Siapkan data untuk dikirim ke Google Sheet
		var postData = {
			namaSiswa: userData.nama,
			mapel: mapelData.nama,
			skor: finalScore.toFixed(0),
			benar: correctAnswers,
			salah: wrongAnswers,
			total: totalQuestions,
			jawaban: userAnswers // Kirim sebagai array
		};
		
		// 3. Kirim data (POST) ke Apps Script
		$.ajax({
			type: "POST",
			url: SCRIPT_URL, // URL yang sama dengan GET
			data: JSON.stringify(postData),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(response) {
				// 4. Tampilkan hasil (setelah berhasil menyimpan)
				$('#loader').fadeOut();
				displayResults(finalScore, totalQuestions, correctAnswers, wrongAnswers);
				sessionStorage.clear(); // Hapus sesi setelah semua selesai
			},
			error: function(xhr, status, error) {
				// Jika gagal simpan, tetap tampilkan hasil tapi beri peringatan
				$('#loader').fadeOut();
				alert("Peringatan: Gagal menyimpan hasil Anda ke server. Harap lapor ke pengawas.\nSkor Anda akan tetap ditampilkan.");
				displayResults(finalScore, totalQuestions, correctAnswers, wrongAnswers);
				sessionStorage.clear();
			}
		});
	}
	
	// Fungsi baru untuk menampilkan halaman hasil
	function displayResults(finalScore, totalQuestions, correctAnswers, wrongAnswers) {
		$('#formContent').html(`
			<div class="fadeIn text-center">
			  <div class="header-icon mb-4">
				<div class="icon-circle" style="background: #28a745;">
				  <i class="fas fa-check"></i>
				</div>
				<h4 class="mt-3 mb-1" style="color: #333; font-weight: 600;">Ujian Selesai</h4>
				<p class="text-muted" style="font-size: 14px;">Terima kasih, ${userData.nama}!</p>
			  </div>
			  
			  <h3 style="font-weight: 700; color: #326698;">Skor Akhir Anda: ${finalScore.toFixed(0)}</h3>
			  
			  <div class="mt-4" style="text-align: left; max-width: 300px; margin: 0 auto;">
				<p style="font-size: 1.1rem;"><strong>Total Soal:</strong> ${totalQuestions}</p>
				<p style="font-size: 1.1rem; color: #28a745;"><strong>Jawaban Benar:</strong> ${correctAnswers}</p>
				<p style="font-size: 1.1rem; color: #dc3545;"><strong>Jawaban Salah:</strong> ${wrongAnswers}</p>
			  </div>
			  
			  <div class="text-center mt-4">
				<button type="button" class="btn btn-primary btn-lg btn-block custom-btn" onClick="window.location.href='index.html'">
				  <i class="fas fa-home mr-2"></i>Kembali ke Halaman Utama
				</button>
			  </div>
			</div>
		`);
	}

</script>
</body>
</html>
